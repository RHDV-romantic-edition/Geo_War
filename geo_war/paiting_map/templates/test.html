<html>
  <head>
    <script src="https://assets.what3words.com/sdk/v3/what3words.js?key=ECNR5N1Y"></script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBlgXXuBdVwQz9NhWXQcbXSBmlNlywH79Y"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <style>
      #map {
        height: 100%;
      }

      html, body {
        height: 100%;
        margin: 0;
        padding: 0;
      }
    </style>
  </head>

  <body>
    <a href="http://127.0.0.1:8000/home/">loguot</a>
    <div id="map"></div>
    <script>
    function sleep(ms) {
      return new Promise(resolve => setTimeout(resolve, ms));
    }

      // Create the Google Map
      let map = new google.maps.Map(document.getElementById("map"), {
        center: { lat: 51.52086, lng: -0.195499 },
        zoom: 19
      });
    </script>
    <script>
      var gridData;

      // Add the what3words grid to the Google Map data layer once the desired zoom level is meet
      map.addListener('bounds_changed', function() {
        const zoom = map.getZoom();
        const loadFeatures = zoom > 17;

        if (loadFeatures) { // Zoom level is high enough
          var ne = map.getBounds().getNorthEast();
          var sw = map.getBounds().getSouthWest();

          // Call the what3words Grid API to obtain the grid squares within the current visble bounding box
          what3words.api
            .gridSectionGeoJson({
              southwest: {
                lat: sw.lat(), lng: sw.lng()
              },
              northeast: {
                lat: ne.lat(), lng: ne.lng()
              }
            }).then(function(data) {
              if (gridData !== undefined) {
                for (var i = 0; i < gridData.length; i++) {
                    map.data.remove(gridData[i]);
                }
              }
              gridData = map.data.addGeoJson(data);
            }).catch(console.error);
        }

        // Set the grid display style
        map.data.setStyle({
          visible: loadFeatures,
          strokeColor: '#777',
          strokeWeight: 0.5,
        });
//{"southwest":{"lng":37.62931,"lat":55.742373},"northeast":{"lng":37.629358,"lat":55.7424}}
      });
        async function CheckDelta(){
        var Url = 'http://127.0.0.1:8000/home/get_delta/'
        var delta = 0
        axios.get(Url)
        .then((response) => {
          delta = (response.data);
          console.log('kek')
          console.log(delta)
          console.log('kek')

          for (var cell in delta){
            cords = cell.split(';')
          var rectangle = new google.maps.Rectangle({
        strokeColor: '#FF000000',
        strokeOpacity: 0.8,
        strokeWeight: 2,
        fillColor: delta[cell],
        fillOpacity: 0.35,
        map: map,
        bounds: {
          north: parseFloat(cords[0]),
          south: parseFloat(cords[1]),
          east: parseFloat(cords[2]),
          west: parseFloat(cords[3]),
        }
      })
      }
    });
      }
      async function Update(){
          CheckDelta()
      }
      map.addListener('click', function(e) {
        Url = 'http://127.0.0.1:8000/home/square_add/'
        axios({
          method: 'post',
          url: Url,
          data: {
            'cords': e.latLng,
            'team': "{{team}}"
              },
          xsrfHeaderName: "X-CSRFToken",
          headers:
          {
            "X-CSRFToken": "{{csrf_token}}"
          }
          })
          .then(response => {
          //console.log(response)
          })
          .catch(error => {
         //console.log(error.response)
        });
      });
      var data = {{my_data|safe}};
    for (var cell in data){
      cords = cell.split(';')
      //console.log(cell)
    var rectangle = new google.maps.Rectangle({
  strokeColor: '#FF000000',
  strokeOpacity: 0.8,
  strokeWeight: 2,
  fillColor: data[cell],
  fillOpacity: 0.35,
  map: map,
  bounds: {
    north: parseFloat(cords[0]),
    south: parseFloat(cords[1]),
    east: parseFloat(cords[2]),
    west: parseFloat(cords[3]),
  }
})
}
let timerId = setInterval(() => Update(), 100);
//await Update()
    </script>
  </body>
</html>
